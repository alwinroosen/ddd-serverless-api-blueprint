image: node:24

definitions:
  caches:
    sonar: ~/.sonar/cache
  services:
    docker:
      memory: 2048

# CI/CD Pipeline with Quality Gates
# Following IT Handbook standards:
# - Build → Test → Security Scan → Quality Gate → Deploy
# - All quality gates must pass (hard blocks)
# - Zero critical/high vulnerabilities
# - ≥80% test coverage
# - SonarQube quality gate PASSED
# - No linting errors

pipelines:
  pull-requests:
    '**':
      - step:
          name: Build & Lint
          caches:
            - node
          script:
            # Install dependencies
            - npm ci

            # Build all packages
            - npm run build

            # Run ESLint (MUST have 0 errors)
            - npm run lint

            # Run Prettier check (100% compliance)
            - npm run format:check

            # TypeScript type checking
            - npm run type-check

      - step:
          name: Unit Tests & Coverage
          caches:
            - node
          script:
            # Run all tests with coverage
            - npm run test:coverage

            # Verify coverage threshold (≥80%)
            - echo "Verifying test coverage meets 80% threshold..."

          artifacts:
            - coverage/**
            - "**/coverage/**"

      - step:
          name: Security Scanning
          caches:
            - node
          script:
            # Install Snyk globally
            - npm install -g snyk

            # Run Snyk vulnerability scan
            # MUST have 0 critical/high vulnerabilities (hard block)
            - snyk test --severity-threshold=high --all-projects

            # Generate Snyk report
            - snyk monitor --all-projects || true

      - step:
          name: SonarQube Analysis
          caches:
            - node
            - sonar
          script:
            # Run SonarQube scan
            - pipe: sonarsource/sonarqube-scan:2.0.1
              variables:
                SONAR_HOST_URL: ${SONAR_HOST_URL}
                SONAR_TOKEN: ${SONAR_TOKEN}
                EXTRA_ARGS: >
                  -Dsonar.projectKey=bpost-shopping-cart-api
                  -Dsonar.projectName="Shopping Cart API"
                  -Dsonar.sources=libs,packages
                  -Dsonar.tests=libs,packages
                  -Dsonar.test.inclusions=**/*.spec.ts,**/*.test.ts
                  -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info
                  -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      - step:
          name: Quality Gate Check
          script:
            # Verify SonarQube Quality Gate status
            - pipe: sonarsource/sonarqube-quality-gate:1.0.0
              variables:
                SONAR_TOKEN: ${SONAR_TOKEN}

            # If this step passes, all quality gates have been met
            - echo "✅ All quality gates passed - ready for merge"

  branches:
    main:
      - step:
          name: Build & Test
          caches:
            - node
          script:
            - npm ci
            - npm run build
            - npm run test:coverage

      - step:
          name: Security & Quality
          caches:
            - node
            - sonar
          script:
            # Security scan
            - npm install -g snyk
            - snyk test --severity-threshold=high --all-projects
            - snyk monitor --all-projects

            # SonarQube scan
            - pipe: sonarsource/sonarqube-scan:2.0.1
              variables:
                SONAR_HOST_URL: ${SONAR_HOST_URL}
                SONAR_TOKEN: ${SONAR_TOKEN}

            # Quality gate check
            - pipe: sonarsource/sonarqube-quality-gate:1.0.0
              variables:
                SONAR_TOKEN: ${SONAR_TOKEN}

      - step:
          name: Generate OpenAPI & Terraform Config
          caches:
            - node
          script:
            # Generate OpenAPI specification
            - npm run generate:openapi

            # Generate Terraform configuration
            - npm run generate:terraform

          artifacts:
            - terraform/generated/**

      - step:
          name: Build Lambda Packages
          caches:
            - node
          script:
            # Build Lambda functions
            - cd packages/lambda-create-cart && npm run build && cd ../..
            - cd packages/lambda-get-cart && npm run build && cd ../..
            - cd packages/lambda-add-item && npm run build && cd ../..

            # Create deployment packages
            - cd packages/lambda-create-cart && zip -r dist.zip dist node_modules && cd ../..
            - cd packages/lambda-get-cart && zip -r dist.zip dist node_modules && cd ../..
            - cd packages/lambda-add-item && zip -r dist.zip dist node_modules && cd ../..

          artifacts:
            - packages/*/dist.zip

      - step:
          name: Deploy to Development
          deployment: development
          script:
            # Install Terraform
            - wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
            - unzip terraform_1.6.0_linux_amd64.zip
            - mv terraform /usr/local/bin/

            # Navigate to dev environment
            - cd terraform/environments/dev

            # Initialize Terraform
            - terraform init

            # Plan deployment
            - terraform plan -out=tfplan

            # Apply deployment
            - terraform apply -auto-approve tfplan

            # Output API endpoint
            - terraform output api_endpoint

    # Production deployment (manual trigger only)
    production:
      - step:
          name: Build & Test
          caches:
            - node
          script:
            - npm ci
            - npm run build
            - npm run test:coverage
            - npm run lint
            - npm run format:check

      - step:
          name: Security & Quality Gates
          caches:
            - node
            - sonar
          script:
            - npm install -g snyk
            - snyk test --severity-threshold=high --all-projects
            - pipe: sonarsource/sonarqube-scan:2.0.1
              variables:
                SONAR_HOST_URL: ${SONAR_HOST_URL}
                SONAR_TOKEN: ${SONAR_TOKEN}
            - pipe: sonarsource/sonarqube-quality-gate:1.0.0
              variables:
                SONAR_TOKEN: ${SONAR_TOKEN}

      - step:
          name: Deploy to Production
          deployment: production
          trigger: manual
          script:
            # Install Terraform
            - wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
            - unzip terraform_1.6.0_linux_amd64.zip
            - mv terraform /usr/local/bin/

            # Navigate to prod environment
            - cd terraform/environments/prod

            # Initialize Terraform
            - terraform init

            # Plan deployment
            - terraform plan -out=tfplan

            # Require manual approval before apply
            - echo "Review the plan above. Proceeding with deployment..."

            # Apply deployment
            - terraform apply -auto-approve tfplan

            # Output API endpoint
            - terraform output api_endpoint
